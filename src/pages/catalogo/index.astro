---
import { getCollection } from "astro:content";
import Layout from "@/layouts/Layout.astro";

// 1. CARICAMENTO DATI
const prodotti = await getCollection("catalogo");
const baseUrl = import.meta.env.BASE_URL;

// 2. LOGICA CATEGORIE (Gestisce sia "Fotografia" che "Fotografia/Analogica")
const strutturaCategorie = prodotti.reduce((acc, p) => {
    const catFull = p.data.categoria || "Altro";
    const [padre, figlio] = catFull.split('/');
    
    if (!acc[padre]) acc[padre] = new Set();
    if (figlio) acc[padre].add(figlio);
    
    return acc;
}, {});

const padri = Object.keys(strutturaCategorie).sort();
---

<Layout titolo="Il Nostro Catalogo">
    <section class="py-12">
        <h1 class="text-6xl font-display mb-4 text-brand-orange italic">Il Catalogo</h1>
        <p class="text-xl max-w-2xl text-brand-yellow font-body">
            Oggetti del passato prossimo selezionati con cura.
        </p>
    </section>

    <section class="sticky py-8 top-16 z-30 mb-10 bg-brand-green/95 backdrop-blur-sm">
        <div class="flex flex-col md:flex-row gap-4 items-stretch">
            <div class="grow">
                <input
                    type="text"
                    id="searchBar"
                    placeholder="Cerca un pezzo unico..."
                    class="w-full h-full p-4 border-4 border-brand-brown shadow-retro focus:outline-none bg-white font-body"
                />
            </div>

            <div class="relative group min-w-[240px]">
                <button id="categoryDisplay" class="w-full h-full p-4 border-4 border-brand-brown bg-brand-yellow font-bold uppercase text-sm flex justify-between items-center shadow-retro">
                    <span id="currentCategoryText">Tutte le Categorie</span>
                    <span class="ml-2">▼</span>
                </button>
                
                <div class="absolute top-[calc(100%+4px)] left-0 w-full bg-white border-4 border-brand-brown hidden group-hover:block z-50 shadow-retro">
                    <button class="w-full text-left p-3 hover:bg-brand-orange hover:text-white border-b-2 border-brand-brown uppercase text-xs font-bold filter-btn" data-category="all">
                        Mostra Tutto
                    </button>
                    
                    {padri.map(padre => (
                        <div class="relative sub-group">
                            <button class="w-full text-left p-3 border-b-2 border-brand-brown flex justify-between items-center hover:bg-brand-orange hover:text-white uppercase text-xs font-bold filter-btn" data-category={padre}>
                                {padre} 
                                {strutturaCategorie[padre].size > 0 && <span class="text-[10px]">▶</span>}
                            </button>
                            
                            {strutturaCategorie[padre].size > 0 && (
                                <div class="absolute top-[-4px] left-[calc(100%+4px)] w-full bg-white border-4 border-brand-brown hidden sub-group-hover shadow-retro">
                                    {[...strutturaCategorie[padre]].sort().map(figlio => (
                                        <button class="w-full text-left p-3 border-b-2 border-brand-brown hover:bg-brand-yellow uppercase text-[10px] font-bold filter-btn" data-category={`${padre}/${figlio}`}>
                                            {figlio}
                                        </button>
                                    ))}
                                </div>
                            )}
                        </div>
                    ))}
                </div>
            </div>

            <div class="flex items-center gap-2 px-4 border-4 border-brand-brown bg-white shadow-retro h-[60px]">
                <input type="checkbox" id="availableOnly" checked class="w-5 h-5 accent-brand-orange" />
                <label for="availableOnly" class="font-bold uppercase text-[10px] whitespace-nowrap cursor-pointer">Solo disponibili</label>
            </div>
        </div>
    </section>

    <div id="productGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10 mb-20">
        {prodotti.map((p) => (
            <div 
                class="product-card" 
                data-nome={p.data.nome.toLowerCase()} 
                data-categoria={p.data.categoria} 
                data-disponibile={p.data.disponibile.toString()}
            >
                <a href={`${baseUrl}catalogo/${p.id}`} class="block bg-white border-4 border-brand-brown shadow-retro hover:shadow-retro-hover transition-all overflow-hidden h-full group">
                    <div class="aspect-square border-b-4 border-brand-brown overflow-hidden relative bg-brand-yellow/5">
                        <img 
                            src={p.data.imageUrls[0]} 
                            alt={p.data.nome} 
                            class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-500" 
                        />
                        {!p.data.disponibile && (
                            <div class="absolute inset-0 bg-white/40 flex items-center justify-center backdrop-blur-[2px]">
                                <span class="bg-brand-brown text-white px-4 py-2 font-display text-2xl rotate-[-5deg] shadow-lg border-2 border-white">
                                    VENDUTO
                                </span>
                            </div>
                        )}
                        <div class="absolute top-4 left-4">
                             <span class="bg-brand-yellow text-brand-brown text-[10px] font-bold px-2 py-1 border-2 border-brand-brown uppercase shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">
                                {p.data.stato}
                             </span>
                        </div>
                    </div>
                    
                    <div class="p-6">
                        <h3 class="text-2xl font-display mb-1 leading-tight">{p.data.nome}</h3>
                        <p class="text-[10px] font-bold text-brand-green uppercase tracking-[0.2em] mb-4">
                            {p.data.categoria.replace('/', ' / ')}
                        </p>
                        
                        <div class="flex justify-between items-center border-t-2 border-brand-brown pt-4 font-body">
                            <span class="text-xs bg-brand-brown text-white px-2 py-1">
                                {p.data.anno}
                            </span>
                            <span class="text-xl font-bold text-brand-orange">
                                {p.data.prezzo} {p.data.valuta}
                            </span>
                        </div>
                    </div>
                </a>
            </div>
        ))}
    </div>
</Layout>

<style>
    .sub-group:hover .sub-group-hover { display: block !important; }
</style>

<script>
    const searchBar = document.getElementById("searchBar") as HTMLInputElement;
    const availableOnly = document.getElementById("availableOnly") as HTMLInputElement;
    const cards = document.querySelectorAll(".product-card");
    const filterButtons = document.querySelectorAll(".filter-btn");
    const currentCategoryText = document.getElementById("currentCategoryText");
    
    let activeCategory = "all";

    function filterProducts() {
        const searchTerm = searchBar.value.toLowerCase();
        const onlyAvailable = availableOnly.checked;

        cards.forEach((card) => {
            const element = card as HTMLElement;
            const nome = element.dataset.nome || "";
            const cat = element.dataset.categoria || "";
            const disp = element.dataset.disponibile === "true";

            const matchesSearch = nome.includes(searchTerm);
            const matchesCat = activeCategory === "all" || cat === activeCategory || cat.startsWith(activeCategory + "/");
            const matchesDisp = !onlyAvailable || disp === true;

            element.style.display = (matchesSearch && matchesCat && matchesDisp) ? "block" : "none";
        });
    }

    filterButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            activeCategory = btn.getAttribute('data-category') || "all";
            if (currentCategoryText) currentCategoryText.textContent = btn.textContent?.trim() || "Tutte le Categorie";
            filterProducts();
        });
    });

    searchBar?.addEventListener("input", filterProducts);
    availableOnly?.addEventListener("change", filterProducts);
    filterProducts();
</script>